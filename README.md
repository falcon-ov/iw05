# Лабораторная работа 05: — Автоматизация конфигурации серверов с помощью Ansible и Jenkins

## Описание проекта

В рамках лабораторной работы **Lab05** я настроил среду автоматизации, состоящую из Jenkins, SSH-агента, Ansible-агента и тестового сервера. Для автоматизации я использовал **Docker Compose**, **Ansible** и **Jenkins Pipelines**.
Основная цель — полностью автоматизировать процесс:

* сборка PHP-проекта и запуск тестов,
* конфигурация тестового сервера через Ansible,
* деплой PHP-приложения на тестовый сервер.

Работа выполнялась на основе предыдущего задания **lab04**, файлы которого были перенесены в каталог **lab05**.

---

## 1. Настройка Jenkins Controller

Переименовал файл **docker-compose.yml** в **compose.yaml**, в этом файле я создал сервис `jenkins-controller`.
Контейнер был запущен через Docker Compose, после чего выполнена стандартная настройка Jenkins через веб-интерфейс.
Были установлены необходимые плагины:

* Docker
* Docker Pipeline
* GitHub Integration
* SSH Agent

Jenkins далее использовался для выполнения всех этапов автоматизации.

---

## 2. Настройка SSH-Agent

Для SSH-агента был создан файл **Dockerfile.ssh_agent**, где я установил необходимые пакеты (PHP-CLI и дополнительные зависимости для тестов).
Также были созданы SSH-ключи, которые я привязал к Jenkins через параметр **SSH Agent Credentials**.

В **compose.yaml** добавлен сервис `ssh-agent` на основе созданного Dockerfile.

SSH-агент используется Jenkins’ом для:

* запуска сборки PHP проекта
* выполнения Composer
* запуска phpunit

---

## 3. Создание Ansible Agent

Для Ansible-агента я создал образ (**Dockerfile.ansible_agent**) на базе Ubuntu и установил:

* Ansible
* Python и дополнительные зависимости

Далее созданы две пары SSH ключей:

1. Для подключения Jenkins → Ansible-agent
2. Для подключения Ansible-agent → тестовый сервер (пользователь **ansible**)

В **compose.yaml** был добавлен сервис `ansible-agent`.

---

## 4. Создание тестового сервера

Файл **Dockerfile.test_server** содержит конфигурацию тестового сервера на базе Ubuntu:

* установлен `openssh-server`
* создан пользователь `ansible`
* настроена авторизация по SSH-ключам

Этот сервер используется как тестовая машина, на которую Ansible разворачивает окружение и PHP-проект.

---

## 5. Создание Ansible playbook для настройки тестового сервера

В папке **ansible/** я создал:

### **hosts.ini**

Содержит параметры подключения к тестовому серверу.

### **setup_test_server.yml**

Playbook выполняет следующие задачи:

* установка и настройка Apache2
* установка PHP и необходимых расширений
* настройка виртуального хоста Apache под PHP-проект

Этот плейбук применяется через отдельный Jenkins pipeline.

---

## 6. Pipeline для сборки и тестирования PHP-проекта

В папке **pipelines/** создан файл
**php_build_and_test_pipeline.groovy**, который включает этапы:

1. клонирование репозитория PHP-проекта
2. установка зависимостей через Composer
3. запуск phpunit
4. публикация результатов тестирования

Сборка выполняется через SSH-agent.

---

## 7. Pipeline для конфигурации тестового сервера через Ansible

Создан файл **ansible_setup_pipeline.groovy**, содержащий:

1. клонирование репозитория с плейбуками
2. выполнение Ansible playbook `setup_test_server.yml`

---

## 8. Pipeline для деплоя PHP-проекта на тестовый сервер

Файл **php_deploy_pipeline.groovy** содержит следующие этапы:

1. клонирование PHP-проекта
2. передача файлов на тестовый сервер (scp/ssh)
3. настройка проекта на сервере (при необходимости)
4. деплой также может выполнять Ansible

После выполнения pipelin’а проект становится доступен на тестовом сервере.

---

## 9. Проверка работы

После деплоя я открыл браузер и перешел по адресу тестового сервера.
PHP-приложение успешно запустилось и корректно отображается.

---

# Ответы на вопросы

### **1. Какие преимущества у использования Ansible для конфигурации серверов?**

* нет необходимости устанавливать агенты на целевые машины
* простота — декларативный YAML
* идемпотентность: одна и та же команда дает предсказуемый результат
* легко масштабируется
* хорошо интегрируется с Jenkins
* множество готовых ролей и модулей

### **2. Какие ещё существуют модули Ansible для управления конфигурацией?**

Некоторые популярные:

* `apt`, `yum`, `dnf` — управление пакетами
* `service` — управление системными сервисами
* `copy`, `template`, `fetch`, `synchronize` — работа с файлами
* `user`, `group` — управление пользователями
* `systemd`
* `docker_container`, `docker_image`
* `git`
* `ufw`, `firewalld`
* `cron`

Всего модулей — сотни.

### **3. Какие проблемы возникли при создании Ansible playbook и как они были решены?**

Примеры типичных сложностей:

* Проблемы с SSH-доступом — решено корректной генерацией ключей и правильными правами на `.ssh`
* Ошибки прав доступа Apache — исправлено изменением владельцев файлов и прав директорий
* PHP-расширения не ставились — добавлены необходимые PPA/репозитории и пакеты
* Playbook падал из-за отсутствия idempotency — переписаны tasks с `creates`, `when`, `changed_when`

После корректировок все плейбуки выполняются стабильно.
