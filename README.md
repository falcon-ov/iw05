# Lab05 — Автоматизация конфигурации сервера с помощью Ansible

## Цель
Научиться создавать Ansible playbook’и для автоматизации конфигурации сервера.

## Предварительные требования
Это задание основано на Individual Work IW04.

Создайте папку **lab05** в своём GitHub-репозитории для хранения всех файлов, относящихся к этой индивидуальной работе.  
Для выполнения задания должны быть установлены **Docker** и **Docker Compose**.  
Также у вас должен быть репозиторий с **PHP-проектом, содержащим unit-тесты**, как в Individual Work IW04.

Скопируйте файлы из предыдущей работы **lab04** в папку **lab05**.

Задание включает шаги из предыдущих работ, помеченные как **Review**.

---

## Задание

### Создайте файл `compose.yaml`.

---

## 1. Установка и настройка Jenkins  
> **Review**

Jenkins будет использоваться для управления всеми этапами автоматизации.

- Создайте сервис **jenkins-controller** в `compose.yaml`.  
- Запустите контейнер Jenkins Controller через Docker Compose и выполните настройку, следуя инструкциям на экране.  
- Установите необходимые плагины:  
  **Docker, Docker Pipeline, GitHub Integration, SSH Agent**.

---

## 2. Настройка SSH Agent  
> **Review**

SSH-агент будет использоваться Jenkins для сборки PHP-проекта и запуска unit-тестов.

- Создайте файл **Dockerfile.ssh_agent**(Dockerfile) для SSH-агента.  
- Установите нужные пакеты (PHP-CLI и, возможно, другие зависимости).  
- Создайте SSH-ключи для интеграции Jenkins с SSH-агентом и настройте Jenkins на использование этих ключей.  
- Добавьте сервис **ssh-agent** в compose.yaml.

---

## 3. Создание Ansible Agent

Ansible-агент будет использоваться Jenkins для выполнения Ansible playbook'ов, которые будут настраивать тестовый сервер.

- Создайте файл **Dockerfile.ansible_agent** на базе Ubuntu. Установите Ansible и необходимые зависимости.  
- Создайте SSH-ключи для интеграции Jenkins с Ansible-агентом и настройте Jenkins для их использования.  
- Создайте SSH-ключи для подключения Ansible-агента к тестовому серверу и настройте Ansible на их применение. Подключение должно выполняться от пользователя **ansible**.  
- Добавьте сервис **ansible-agent** в compose.yaml.

---

## 4. Создание Test Server

Тестовый сервер будет представлять тестовую среду, которая будет настраиваться Ansible playbook’ами и в которой будет проверяться работа PHP-приложения.

- Создайте файл **Dockerfile.test_server** на основе Ubuntu.  
- Установите **openssh-server** и настройте его на работу с SSH-ключами.  
- Создайте пользователя **ansible** и настройте SSH-доступ с использованием созданных ранее ключей.

---

## 5. Создание Ansible Playbook для конфигурации тестового сервера

- Создайте папку **ansible**.  
- Внутри создайте файл inventory — **hosts.ini**.  
- Создайте playbook **setup_test_server.yml**, выполняющий:

### Задачи:
- Установка и настройка **Apache2**  
- Установка и настройка **PHP** и нужных расширений  
- Настройка Apache **virtual host** для PHP-проекта  

---

## 6. Pipeline для сборки и тестирования PHP-проекта  
> **Review**

- Создайте папку **pipelines**.  
- Создайте Jenkins pipeline для сборки и тестирования PHP-проекта с использованием SSH-агента.  
- Сохраните как **php_build_and_test_pipeline.groovy**.

### Этапы pipeline:
1. Клонирование репозитория PHP-проекта  
2. Установка зависимостей через **Composer**  
3. Запуск тестов через **PHPUnit**  
4. Отчёт о результатах тестирования  

---

## 7. Pipeline для конфигурации тестового сервера с Ansible

- Создайте Jenkins pipeline для настройки тестового сервера с Ansible-агентом.  
- Сохраните как **ansible_setup_pipeline.groovy**.

### Этапы:
1. Клонирование репозитория с Ansible playbook  
2. Выполнение playbook для настройки тестового сервера  

---

## 8. Pipeline для деплоя PHP-проекта на тестовый сервер

- Создайте Jenkins pipeline для деплоя PHP-проекта на тестовый сервер.  
- Сохраните как **php_deploy_pipeline.groovy**.

### Этапы:
1. Клонирование репозитория с PHP-проектом  
2. Копирование файлов на тестовый сервер  
3. Конфигурация проекта (если нужно)  
4. Деплой (может быть выполнен через Ansible)  

---

## 9. Тестирование развернутого PHP-проекта

Откройте браузер и перейдите по адресу тестового сервера.  
Убедитесь, что проект работоспособен.

---

# Подготовка отчёта

Создайте **readme.md** в папке lab05.

### В отчёт включить:
- описание проекта  
- шаги настройки Jenkins Controller  
- шаги настройки SSH-агента  
- шаги конфигурации Ansible-агента  
- шаги создания тестового сервера  
- описание Ansible playbook и его задач  
- описание Jenkins pipelines:
  - сборка и тестирование PHP-проекта  
  - настройка тестового сервера  
  - деплой PHP-проекта  

### Ответить на вопросы:
1. Каковы преимущества использования Ansible для конфигурации сервера?  
2. Какие другие модули Ansible существуют для управления конфигурациями?  
3. Какие проблемы возникли при создании playbook и как они были решены?

